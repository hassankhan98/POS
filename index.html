<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>POS Web App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {background:#f8f9fc;}
    .sidebar {height:100vh;background:#343a40;color:white;padding-top:20px;}
    .sidebar a {color:white;display:block;padding:10px;text-decoration:none;}
    .sidebar a:hover {background:#495057;}
    .content {padding:20px;}
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-2 sidebar">
      <h4 class="text-center">POS Dashboard</h4>
      <a href="#" onclick="showSection('dashboard')">Dashboard</a>
      <a href="#" onclick="showSection('products')">Add Products</a>
      <a href="#" onclick="showSection('sales')">Sales Record</a>
      <a href="#" onclick="showSection('export')">Export</a>
    </div>

    <!-- Main Content -->
    <div class="col-md-10 content">
      <!-- Dashboard -->
      <div id="dashboard" class="section">
        <h2>Dashboard</h2>
        <div class="row">
          <div class="col-md-4"><canvas id="salesChart"></canvas></div>
          <div class="col-md-4"><canvas id="platformChart"></canvas></div>
        </div>
      </div>

      <!-- Add Products -->
      <div id="products" class="section" style="display:none;">
        <h2>Add Product</h2>
        <form id="productForm" class="mb-3">
          <input class="form-control mb-2" placeholder="Product Name" id="productName" required>
          <input class="form-control mb-2" type="number" placeholder="Cost Price" id="costPrice" required>
          <input class="form-control mb-2" type="number" placeholder="Units" id="units" required>
          <button class="btn btn-primary" type="submit">Add Product</button>
        </form>
        <ul id="productList" class="list-group"></ul>
      </div>

      <!-- Sales Record -->
      <div id="sales" class="section" style="display:none;">
        <h2>Sales Record</h2>
        <form id="salesForm" class="mb-3">
          <select id="saleProduct" class="form-control mb-2"></select>
          <input class="form-control mb-2" type="number" placeholder="Sold Price" id="soldPrice" required>
          <select class="form-control mb-2" id="platform">
            <option>TikTok</option>
            <option>eBay</option>
            <option>Vinted</option>
            <option>Cash</option>
            <option>Facebook</option>
            <option>Depop</option>
          </select>
          <button class="btn btn-success" type="submit">Add Sale</button>
        </form>
        <ul id="salesList" class="list-group"></ul>
      </div>

      <!-- Export Section -->
      <div id="export" class="section" style="display:none;">
        <h2>Export Data</h2>
        <button class="btn btn-danger me-2" onclick="exportPDF()">Export PDF</button>
        <button class="btn btn-success" onclick="exportExcel()">Export Excel</button>
      </div>
    </div>
  </div>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBgG89RoBGc-Gqe2TYnO_iPSdtc8XxQwJw",
  authDomain: "pos-web-app-ed7e9.firebaseapp.com",
  projectId: "pos-web-app-ed7e9",
  storageBucket: "pos-web-app-ed7e9.appspot.com",
  messagingSenderId: "386790885396",
  appId: "1:386790885396:web:83955d99b689cf377ebf01"
};

// Init Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let salesChart, platformChart;

// Section toggle
function showSection(id){
  document.querySelectorAll('.section').forEach(sec=>sec.style.display='none');
  document.getElementById(id).style.display='block';
}

// Add product
document.getElementById('productForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const name=document.getElementById('productName').value;
  const cost=parseFloat(document.getElementById('costPrice').value);
  const units=parseInt(document.getElementById('units').value);
  await db.collection('products').add({name,cost,units});
  e.target.reset();
});

// Show products
db.collection('products').onSnapshot(snap=>{
  const list=document.getElementById('productList');
  const saleSelect=document.getElementById('saleProduct');
  list.innerHTML=''; saleSelect.innerHTML='';
  snap.forEach(doc=>{
    const p=doc.data();
    const li=document.createElement('li');
    li.className='list-group-item d-flex justify-content-between align-items-center';
    li.textContent=`${p.name} (Cost: $${p.cost}, Units: ${p.units})`;
    const btn=document.createElement('button');
    btn.className='btn btn-sm btn-danger'; btn.textContent='Delete';
    btn.onclick=()=>db.collection('products').doc(doc.id).delete();
    li.appendChild(btn);
    list.appendChild(li);
    saleSelect.innerHTML+=`<option value="${doc.id}">${p.name}</option>`;
  });
});

// Add sale
document.getElementById('salesForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const productId=document.getElementById('saleProduct').value;
  const soldPrice=parseFloat(document.getElementById('soldPrice').value);
  const platform=document.getElementById('platform').value;
  await db.collection('sales').add({productId,soldPrice,platform,date:new Date()});
  e.target.reset();
});

// Show sales
db.collection('sales').onSnapshot(async snap=>{
  const list=document.getElementById('salesList'); list.innerHTML='';
  const products=await db.collection('products').get();
  const productMap={}; products.forEach(p=>productMap[p.id]=p.data().name);

  const sales=[];
  snap.forEach(doc=>{
    const s=doc.data(); sales.push({...s,id:doc.id});
    const li=document.createElement('li');
    li.className='list-group-item d-flex justify-content-between align-items-center';
    li.textContent=`${productMap[s.productId]} sold at $${s.soldPrice} on ${s.platform}`;
    const btn=document.createElement('button');
    btn.className='btn btn-sm btn-danger'; btn.textContent='Delete';
    btn.onclick=()=>db.collection('sales').doc(doc.id).delete();
    li.appendChild(btn);
    list.appendChild(li);
  });

  updateCharts(sales);
});

// Charts
function updateCharts(sales){
  const ctx=document.getElementById('salesChart').getContext('2d');
  const platformCtx=document.getElementById('platformChart').getContext('2d');
  const revenueByPlatform={TikTok:0,eBay:0,Vinted:0,Cash:0,Facebook:0,Depop:0};
  sales.forEach(s=>revenueByPlatform[s.platform]+=s.soldPrice);

  if(salesChart) salesChart.destroy();
  if(platformChart) platformChart.destroy();

  salesChart=new Chart(ctx,{type:'bar',
    data:{labels:sales.map(s=>new Date(s.date.seconds*1000).toLocaleDateString()),
          datasets:[{label:'Revenue',data:sales.map(s=>s.soldPrice),backgroundColor:'rgba(54,162,235,0.6)'}]}});
  platformChart=new Chart(platformCtx,{type:'doughnut',
    data:{labels:Object.keys(revenueByPlatform),datasets:[{data:Object.values(revenueByPlatform),backgroundColor:['#000','#0064D2','#f5a623','#28a745','#1877F2','#000']}]},
    options:{plugins:{legend:{position:'bottom'}}}});
}

// Export PDF
async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc=new jsPDF();
  doc.text("Products",10,10);
  const products=await db.collection('products').get();
  let y=20;
  products.forEach(p=>{let d=p.data();doc.text(`${d.name} - Cost: ${d.cost} - Units: ${d.units}`,10,y);y+=10;});
  y+=10; doc.text("Sales",10,y); y+=10;
  const sales=await db.collection('sales').get();
  sales.forEach(s=>{let d=s.data();doc.text(`${d.productId} - Sold: ${d.soldPrice} - ${d.platform}`,10,y);y+=10;});
  doc.save("POS_Data.pdf");
}

// Export Excel
async function exportExcel(){
  const products=await db.collection('products').get();
  const sales=await db.collection('sales').get();
  const productData=products.docs.map(p=>p.data());
  const salesData=sales.docs.map(s=>s.data());
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(productData),"Products");
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(salesData),"Sales");
  XLSX.writeFile(wb,"POS_Data.xlsx");
}
</script>
</body>
</html>
