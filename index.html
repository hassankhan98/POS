<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>POS Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <!-- FileSaver + XLSX + jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { background:#f8f9fc; }
    .sidebar { height:100vh; background:#343a40; color:#fff; padding:1rem; position:fixed; }
    .sidebar a { color:#adb5bd; display:block; margin:0.5rem 0; text-decoration:none; }
    .sidebar a.active, .sidebar a:hover { color:#fff; }
    .content { margin-left:220px; padding:2rem; }
  </style>
</head>
<body>
<div class="sidebar">
  <h4>POS System</h4>
  <a href="#" class="active" onclick="showSection('dashboard')">Dashboard</a>
  <a href="#" onclick="showSection('products')">Products</a>
  <a href="#" onclick="showSection('sales')">Sales</a>
  <a href="#" onclick="showSection('reports')">Reports</a>
</div>

<div class="content">
  <!-- Dashboard -->
  <div id="dashboard" class="section">
    <h2>Dashboard</h2>
    <div class="row mb-4">
      <div class="col-md-3"><div class="card p-3"><h5>Total Products</h5><p id="totalProducts">0</p></div></div>
      <div class="col-md-3"><div class="card p-3"><h5>Total Sales</h5><p id="totalSales">0</p></div></div>
      <div class="col-md-3"><div class="card p-3"><h5>Total Revenue</h5><p id="totalRevenue">£0</p></div></div>
      <div class="col-md-3"><div class="card p-3"><h5>Avg Margin</h5><p id="avgMargin">0%</p></div></div>
    </div>
    <canvas id="salesChart"></canvas>
  </div>

  <!-- Products -->
  <div id="products" class="section d-none">
    <h2>Products</h2>
    <form id="addProductForm" class="mb-3">
      <div class="row">
        <div class="col"><input class="form-control" placeholder="Product Name" id="productName" required></div>
        <div class="col"><input class="form-control" placeholder="Cost Price" type="number" id="costPrice" required></div>
        <div class="col"><input class="form-control" placeholder="Units" type="number" id="units" required></div>
        <div class="col"><button class="btn btn-primary" type="submit">Add Product</button></div>
      </div>
    </form>
    <table class="table table-bordered"><thead><tr><th>Name</th><th>Cost</th><th>Units</th><th>Action</th></tr></thead><tbody id="productTable"></tbody></table>
  </div>

  <!-- Sales -->
  <div id="sales" class="section d-none">
    <h2>Sales</h2>
    <form id="addSaleForm" class="mb-3">
      <div class="row">
        <div class="col"><select class="form-control" id="saleProduct"></select></div>
        <div class="col"><input class="form-control" placeholder="Sold Price" type="number" id="soldPrice" required></div>
        <div class="col">
          <select class="form-control" id="platform">
            <option value="TikTok">TikTok</option>
            <option value="eBay">eBay</option>
            <option value="Vinted">Vinted</option>
            <option value="Cash">Cash</option>
            <option value="Facebook">Facebook</option>
            <option value="Depop">Depop</option>
          </select>
        </div>
        <div class="col"><button class="btn btn-success" type="submit">Record Sale</button></div>
      </div>
    </form>
    <table class="table table-bordered"><thead><tr><th>Product</th><th>Sold Price</th><th>Platform</th><th>Profit</th><th>Action</th></tr></thead><tbody id="salesTable"></tbody></table>
  </div>

  <!-- Reports -->
  <div id="reports" class="section d-none">
    <h2>Reports</h2>
    <button class="btn btn-danger me-2" onclick="exportPDF()">Export PDF</button>
    <button class="btn btn-success" onclick="exportExcel()">Export Excel</button>
  </div>
</div>

<script>
/* ===== Firebase Setup ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBgG89RoBGc-Gqe2TYnO_iPSdtc8XxQwJw",
  authDomain: "pos-web-app-ed7e9.firebaseapp.com",
  projectId: "pos-web-app-ed7e9",
  storageBucket: "pos-web-app-ed7e9.appspot.com",
  messagingSenderId: "386790885396",
  appId: "1:386790885396:web:83955d99b689cf377ebf01"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ===== UI Navigation ===== */
function showSection(id){
  document.querySelectorAll('.section').forEach(sec=>sec.classList.add('d-none'));
  document.getElementById(id).classList.remove('d-none');
  document.querySelectorAll('.sidebar a').forEach(a=>a.classList.remove('active'));
  event.target.classList.add('active');
}

/* ===== Add Product ===== */
const addProductForm = document.getElementById('addProductForm');
addProductForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  await db.collection('products').add({
    name: productName.value,
    cost: parseFloat(costPrice.value),
    units: parseInt(units.value)
  });
  addProductForm.reset();
});

/* ===== Render Products ===== */
const productTable = document.getElementById('productTable');
const saleProduct = document.getElementById('saleProduct');
db.collection('products').onSnapshot(snapshot=>{
  productTable.innerHTML='';
  saleProduct.innerHTML='';
  snapshot.forEach(doc=>{
    const p = doc.data();
    productTable.innerHTML+=`<tr>
      <td>${p.name}</td><td>£${p.cost}</td><td>${p.units}</td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteProduct('${doc.id}')">Delete</button></td>
    </tr>`;
    saleProduct.innerHTML+=`<option value="${doc.id}" data-cost="${p.cost}">${p.name}</option>`;
  });
});

/* ===== Delete Product ===== */
async function deleteProduct(id){
  await db.collection('products').doc(id).delete();
}

/* ===== Add Sale ===== */
const addSaleForm = document.getElementById('addSaleForm');
addSaleForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const prodId = saleProduct.value;
  const prod = await db.collection('products').doc(prodId).get();
  const cost = prod.data().cost;
  const sold = parseFloat(soldPrice.value);
  const profit = sold - cost;
  await db.collection('sales').add({
    product: prod.data().name,
    sold: sold,
    platform: platform.value,
    profit: profit
  });
  addSaleForm.reset();
});

/* ===== Render Sales ===== */
const salesTable = document.getElementById('salesTable');
db.collection('sales').onSnapshot(snapshot=>{
  salesTable.innerHTML='';
  let totalSales=0, totalRevenue=0, totalProfit=0;
  snapshot.forEach(doc=>{
    const s = doc.data();
    totalSales++; totalRevenue+=s.sold; totalProfit+=s.profit;
    salesTable.innerHTML+=`<tr>
      <td>${s.product}</td><td>£${s.sold}</td><td>${s.platform}</td><td>£${s.profit}</td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteSale('${doc.id}')">Delete</button></td>
    </tr>`;
  });
  document.getElementById('totalSales').innerText=totalSales;
  document.getElementById('totalRevenue').innerText='£'+totalRevenue.toFixed(2);
  document.getElementById('avgMargin').innerText=((totalProfit/totalRevenue)*100||0).toFixed(1)+'%';
});

/* ===== Delete Sale ===== */
async function deleteSale(id){
  await db.collection('sales').doc(id).delete();
}

/* ===== Dashboard Products Count ===== */
db.collection('products').onSnapshot(snapshot=>{
  document.getElementById('totalProducts').innerText=snapshot.size;
});

/* ===== Reports Export ===== */
async function exportExcel(){
  const [productsSnap,salesSnap]=await Promise.all([db.collection('products').get(), db.collection('sales').get()]);
  const products=[], sales=[];
  productsSnap.forEach(d=>products.push(d.data()));
  salesSnap.forEach(d=>sales.push(d.data()));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(products),"Products");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(sales),"Sales");
  XLSX.writeFile(wb,"POS_Report.xlsx");
}
async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc=new jsPDF();
  let y=10;
  doc.text("Products",10,y); y+=10;
  const products=await db.collection('products').get();
  products.forEach(p=>{doc.text(`${p.data().name} - £${p.data().cost} - Units: ${p.data().units}`,10,y); y+=10;});
  y+=10; doc.text("Sales",10,y); y+=10;
  const sales=await db.collection('sales').get();
  sales.forEach(s=>{doc.text(`${s.data().product} - £${s.data().sold} - ${s.data().platform} - Profit: £${s.data().profit}`,10,y); y+=10;});
  doc.save("POS_Report.pdf");
}
</script>
</body>
</html>
