<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POS Dashboard</title>
<link rel="stylesheet" href="style.css">
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="firebase-config.js"></script>
</head>
<body>
<div class="container">
  <h1>POS Dashboard</h1>

  <div class="grid">
    <!-- Products Panel -->
    <div class="card">
      <h2>Products</h2>
      <input type="text" id="productName" placeholder="Product Name">
      <input type="number" id="productUnits" placeholder="Units">
      <input type="number" id="productCost" placeholder="Cost Price">
      <button onclick="addProduct()">Add Product</button>

      <h3>Existing Products</h3>
      <ul id="productList"></ul>
    </div>

    <!-- Sales Panel -->
    <div class="card">
      <h2>Sales</h2>
      <select id="saleProduct">
        <option value="">Select Product</option>
      </select>
      <input type="number" id="salePrice" placeholder="Sold Price">
      <select id="salePlatform">
        <option value="">Platform</option>
        <option value="TikTok">TikTok</option>
        <option value="eBay">eBay</option>
        <option value="Vinted">Vinted</option>
        <option value="Cash">Cash</option>
        <option value="Facebook">Facebook</option>
        <option value="Depop">Depop</option>
      </select>
      <button onclick="addSale()">Record Sale</button>

      <h3>Sales History</h3>
      <ul id="salesList"></ul>
    </div>
  </div>

  <!-- Reports -->
  <div class="card">
    <h2>Reports</h2>
    <button onclick="exportExcel()">Download Excel</button>
    <button onclick="exportPDF()">Download PDF</button>
  </div>
</div>

<script>
const productsRef = db.collection("products");
const salesRef = db.collection("sales");

// --- Load Products ---
function loadProducts() {
  productsRef.onSnapshot(snapshot => {
    const select = document.getElementById("saleProduct");
    const list = document.getElementById("productList");
    select.innerHTML = '<option value="">Select Product</option>';
    list.innerHTML = '';
    snapshot.forEach(doc => {
      const data = doc.data();
      select.innerHTML += `<option value="${data.name}" data-cost="${data.cost}" data-id="${doc.id}">${data.name}</option>`;
      list.innerHTML += `<li>${data.name} | Units: ${data.units} | Cost: £${data.cost} <button onclick="removeProduct('${doc.id}')">Remove</button></li>`;
    });
  });
}

// --- Load Sales ---
function loadSales() {
  salesRef.onSnapshot(snapshot => {
    const list = document.getElementById("salesList");
    list.innerHTML = '';
    snapshot.forEach(doc => {
      const s = doc.data();
      list.innerHTML += `<li>${s.product} | Sold: £${s.price} | ${s.platform} | Profit: £${s.profit} <button onclick="removeSale('${doc.id}')">Remove</button></li>`;
    });
  });
}

// --- Add Product ---
function addProduct() {
  const name = document.getElementById("productName").value;
  const units = parseInt(document.getElementById("productUnits").value);
  const cost = parseFloat(document.getElementById("productCost").value);
  if(!name || !units || !cost) return alert("Fill all fields");

  productsRef.add({ name, units, cost })
    .then(() => { alert("Product added"); document.getElementById("productName").value=""; document.getElementById("productUnits").value=""; document.getElementById("productCost").value=""; })
    .catch(err => alert(err));
}

// --- Add Sale ---
function addSale() {
  const productSelect = document.getElementById("saleProduct");
  const productName = productSelect.value;
  const price = parseFloat(document.getElementById("salePrice").value);
  const platform = document.getElementById("salePlatform").value;
  if(!productName || !price || !platform) return alert("Fill all fields");

  const cost = parseFloat(productSelect.selectedOptions[0].dataset.cost);
  const profit = price - cost;

  salesRef.add({ product: productName, price, platform, profit })
    .then(() => { alert("Sale recorded"); document.getElementById("salePrice").value=""; document.getElementById("salePlatform").value=""; })
    .catch(err => alert(err));
}

// --- Remove Product ---
function removeProduct(id) {
  if(confirm("Are you sure you want to remove this product?")) {
    productsRef.doc(id).delete();
  }
}

// --- Remove Sale ---
function removeSale(id) {
  if(confirm("Are you sure you want to remove this sale?")) {
    salesRef.doc(id).delete();
  }
}

// --- Export Excel ---
function exportExcel() {
  salesRef.get().then(snapshot => {
    const data = snapshot.docs.map(doc => doc.data());
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Sales");
    XLSX.writeFile(wb, "sales_report.xlsx");
  });
}

// --- Export PDF ---
function exportPDF() {
  salesRef.get().then(snapshot => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Sales Report", 20, 10);
    snapshot.docs.forEach((docData, i) => {
      const s = docData.data();
      doc.text(`${i+1}. ${s.product} | Sold: £${s.price} | ${s.platform} | Profit: £${s.profit}`, 20, 20 + i*10);
    });
    doc.save("sales_report.pdf");
  });
}

// --- Initial Load ---
loadProducts();
loadSales();
</script>
</body>
</html>
